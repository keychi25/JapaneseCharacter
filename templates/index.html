{% extends "layout.html" %}
{% block content %}

<div class="row">
  <div class="col-sm-10">
    <h3>実行方法</h3>
    <form action="/run" method="post" enctype="multipart/form-data">
      <div class="form-group col-md-6">
        <label for="hiraga">書いたひらがなの文字</label>
        <input type="text" class="form-control" name="hiragana" id="hiragana" placeholder="ひらがなを1文字入力してください"
          data-required-error="ひらがなの入力は必須です" maxlength="1" required>
      </div>
      <div class="form-group col-md-6">
        <label for="image">ひらがなの写真</label>
        <input type="file" name="image" id="image" required>
        <input type="hidden" name="canvas" value="False">
      </div>
      <div class="form-group col-md-6">
        <input type="submit" class="btn-primary" value="確認する">
      </div>
    </form>
    <hr>
    <h3>ダウンロード</h3>
    <div class="form-group col-md-6">
      <label for="image">ひらがなの写真</label>
      <canvas id="canvassample" width="500" height="500">
        <input type="file" name="image" id="newImg" required readonly>
      </canvas>
      <div style="padding:10px">
        <a id="download" href="#" class="btn-primary" download="canvas.jpg" onclick="chgImg()" value="1">ダウンロード</a>
        <button class="btn-danger" onclick="clearCanvas()">リセット</button>
      </div>
    </div>
  </div>
</div>
<script>
  const cnvWidth = 500;
  const cnvHeight = 500;
  var canvas = document.getElementById('canvassample'),
    ctx = canvas.getContext('2d'),
    moveflg = 0,
    Xpoint,
    Ypoint;

  //初期値（サイズ、色、アルファ値）の決定
  var defSize = 7,
    defColor = "#555";

  // ストレージの初期化
  var myStorage = localStorage;
  window.onload = initLocalStorage();
  var bgColor = "rgb(255,255,255)";
  setBgColor()
  // PC対応
  canvas.addEventListener('mousedown', startPoint, false);
  canvas.addEventListener('mousemove', movePoint, false);
  canvas.addEventListener('mouseup', endPoint, false);
  // スマホ対応
  canvas.addEventListener('touchstart', startPoint, false);
  canvas.addEventListener('touchmove', movePoint, false);
  canvas.addEventListener('touchend', endPoint, false);

  function startPoint(e) {
    e.preventDefault();
    ctx.beginPath();
    Xpoint = e.layerX;
    Ypoint = e.layerY;

    ctx.moveTo(Xpoint, Ypoint);
  }

  function movePoint(e) {
    if (e.buttons === 1 || e.witch === 1 || e.type == 'touchmove') {
      Xpoint = e.layerX;
      Ypoint = e.layerY;
      moveflg = 1;

      ctx.lineTo(Xpoint, Ypoint);
      ctx.lineCap = "round";
      ctx.lineWidth = defSize * 2;
      ctx.strokeStyle = defColor;
      ctx.stroke();
    }
  }

  function endPoint(e) {

    if (moveflg === 0) {
      ctx.lineTo(Xpoint - 1, Ypoint - 1);
      ctx.lineCap = "round";
      ctx.lineWidth = defSize * 2;
      ctx.strokeStyle = defColor;
      ctx.stroke();
    }
    moveflg = 0;
    setLocalStoreage();
  }

  function clearCanvas() {
    if (confirm('Canvasを初期化しますか？')) {
      initLocalStorage();
      temp = [];
      resetCanvas();
      setBgColor()
    }
  }

  function resetCanvas() {
    ctx.clearRect(0, 0, ctx.canvas.clientWidth, ctx.canvas.clientHeight);
  }

  function chgImg() {
    var png = canvas.toDataURL("image/jpeg");
    document.getElementById("download").href = png;
  }

  function initLocalStorage() {
    myStorage.setItem("__log", JSON.stringify([]));
  }
  function setLocalStoreage() {
    var png = canvas.toDataURL();
    var logs = JSON.parse(myStorage.getItem("__log"));
    setTimeout(function () {
      logs.unshift({ 0: png });
      myStorage.setItem("__log", JSON.stringify(logs));
      currentCanvas = 0;
      temp = [];
    }, 0);
  }

  function draw(src) {
    var img = new Image();
    img.src = src;
    img.onload = function () {
      ctx.drawImage(img, 0, 0);
    }
  }
  function setBgColor() {
    // canvasの背景色を設定(指定がない場合にjpeg保存すると背景が黒になる)
    ctx.fillStyle = bgColor;
    ctx.fillRect(0, 0, cnvWidth, cnvHeight);
  }

</script>
<script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<style>
  canvas {
    border: 3px solid #000;
  }
</style>
{% endblock %}